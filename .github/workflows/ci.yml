name: CI

on:
  pull_request:
    paths-ignore:
      - "**.md"

  push:
    branches:
      # latest release
      - master
      # pre releases
      - next
      - alpha
      - beta
      # snapshot releases
      - snapshot
      # maintenance releases
      - v[0-9]+.x
      - v[0-9]+.[0-9]+.x

env:
  CI: true

jobs:
  checks:
    name: Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Detect format file changes
        id: changed-format-files
        uses: tj-actions/changed-files@v37

      - name: Format all changed fiels
        run: pnpm format ${{ steps.changed-format-files.outputs.target_all_changed_files }} --no-error-on-unmatched-pattern --write

      - name: Commit formated files
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Format with Prettier"
          file_pattern: ${{ steps.changed-format-files.outputs.target_all_changed_files }}

      - name: Detect lint file changes
        id: changed-lint-files
        uses: tj-actions/changed-files@v37
        with:
          files_yaml: |
            eslint:
              - .eslintrc.json
              - .eslintignore
              - pnpm-lock.yaml
            target:
              - "**/*.{ts,tsx,js,jsx}"

      - name: Lint all files
        id: lint-all
        if: ${{ github.event_name == 'push' || steps.changed-lint-files.outputs.eslint_any_changed == 'true' }}
        run: pnpm lint .

      - name: Lint changed files
        if: ${{ steps.lint-all.outcome == 'skipped' && steps.changed-lint-files.outputs.target_any_changed == 'true' }}
        run: pnpm lint ${{ steps.changed-lint-files.outputs.target_all_changed_files }} --no-error-on-unmatched-pattern

      - name: Type check
        if: ${{ always() }}
        run: pnpm typecheck

      - name: Tests with coverage
        if: ${{ always() }}
        run: pnpm test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          fail_ci_if_error: false

  test-dist:
    name: Run tests against dist files
    runs-on: ubuntu-latest
    strategy:
      matrix:
        filename: [index.js, index.cjs]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Build
        run: pnpm build

      - name: Cleanup src folder
        run: rm -rf src/*

      - name: Create a symlink to the built file from src folder
        # [s] - symbolic
        # [F] - force, remove existing destination files
        # [f] - unlink file if it already exists
        run: cd src && ln -sFf ../dist/${{ matrix.filename }} index.js && cd ..

      - name: Test
        run: pnpm test:run

  test-legacy:
    name: Run tests against legacy React
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: [16.12.0, 17.0.0, 18.0.0]
        include:
          - version: 16.12.0
            legacy_testing_library: true
          - version: 17.0.0
            legacy_testing_library: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Install React@${{ matrix.version }}
        run: pnpm add -D react@${{ matrix.version }} react-dom@${{ matrix.version }}

      - name: Install legacy testing-library
        if: ${{ matrix.legacy_testing_library }}
        run: pnpm add -D @testing-library/react@12 @testing-library/react-hooks

      - name: Test against React@${{ matrix.version }}
        run: pnpm test:run

  size-limit:
    name: Size Limit
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Check size
        uses: andresz1/size-limit-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          skip_step: install
          build_script: build:minified

  release:
    name: Release on npm
    runs-on: ubuntu-latest
    needs: [checks, test-dist, test-legacy]
    # prevents this action from running on forks and only on pushes
    if: ${{ github.repository_owner == 'owanturist' && github.event_name == 'push' }}
    concurrency: ${{ github.workflow }}-${{ github.ref }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # This makes Actions fetch all Git history so that Changesets can generate changelogs with the correct commits
          fetch-depth: 0

      - name: Setup environment
        uses: ./.github/actions/setup-env

      - name: Change .changeset baseBranch to the current branch
        run: |
          perl -i -pe"s/\"baseBranch\":.*/\"baseBranch\": \"${{ github.ref_name }}\",/g" .changeset/config.json

      - name: Commit updated .changeset config
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Change .changeset `baseBranch` to ${{ github.ref_name }}"
          file_pattern: ".changeset/config.json"

      - name: Get changeset status
        run: pnpm cs status --output ./changeset-status.json

      - name: Read the new version
        id: new-version
        uses: notiz-dev/github-action-json-property@release
        continue-on-error: true
        with:
          path: ./changeset-status.json
          prop_path: "releases.0.newVersion"

      - name: Read the old version
        id: old-version
        uses: notiz-dev/github-action-json-property@release
        with:
          path: ./package.json
          prop_path: "version"

      - name: Create Release Pull Request or Publish to npm
        uses: changesets/action@v1
        with:
          publish: pnpm run publish --tag=${{ github.ref_name == 'master' && 'latest' || github.ref_name == 'next' && 'next' || github.ref_name == 'alpha' && 'alpha' || github.ref_name == 'beta' && 'beta' || ' ' }}
          commit: Release `${{ steps.old-version.outputs.prop }}` -> `${{ steps.new-version.outputs.prop }}`
          title: Release `${{ steps.old-version.outputs.prop }}` -> `${{ steps.new-version.outputs.prop }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
